pipeline {
    agent none

    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        TF_IN_AUTOMATION   = 'true'
    }

    stages {
        stage('Checkout') {
            agent { label 'terraform' } // Puede ser cualquier agente con git
            steps {
                checkout scm
            }
        }

        stage('Build Backend (Java)') {
            agent { label 'maven' } // <-- Usando el nuevo agente Maven
            steps {
                dir('App/backend/academia-baile-backend') {
                    sh 'mvn clean package -DskipTests' // Compila y empaqueta el JAR
                }
            }
        }
        
        // ... Tus etapas existentes ...

        stage('1. Linting y validación Terraform') { ... }
        stage('2. Checkov (seguridad IaC)') {
             agent { label 'docker' } // Usando el agente Docker dedicado
             steps {
                dir('infra') {
                    sh '''
                       docker run --rm -v "$PWD:/tf" bridgecrew/checkov:latest -d /tf
                    '''
                }
             }
        }
        stage('3. Test unitarios (Node)') { ... }
        stage('4. Terraform Plan (preview)') { ... }
        stage('5. Aprobación manual') { ... }
        stage('6. Terraform Apply') { ... }
    }
    post { ... }
}
