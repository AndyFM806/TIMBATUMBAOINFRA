# No usamos 'version' porque está obsoleto.

services:
  # ----- CONSTRUCCIÓN DE AGENTES (esto no cambia) -----
  terraform-agent:
    image: custom-agent/terraform
    build:
      context: ./agents/terraform

  node-agent:
    image: custom-agent/node
    build:
      context: ./agents/node

  maven-agent:
    image: custom-agent/maven
    build:
      context: ./agents/maven

  docker-agent:
    image: custom-agent/docker
    build:
      context: ./agents/docker

  # ----- CONTROLADOR DE JENKINS (aquí está la corrección) -----
  jenkins-controller:
    # En lugar de 'image', usamos 'build' para que use nuestro Dockerfile
    build:
      context: .  # El '.' significa 'este mismo directorio', es decir, la carpeta 'jenkins'
      dockerfile: Dockerfile # Le decimos explícitamente que use tu archivo Dockerfile
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - ./jcasc:/var/jenkins_home/casc_configs
      - jenkins-data:/var/jenkins_home
    environment:
      # Pasamos las credenciales de AWS que exportaste en tu terminal
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    depends_on:
      # Le decimos que espere a que los otros servicios estén listos
      - terraform-agent
      - node-agent
      - maven-agent
      - docker-agent
      - dind

  # ----- DOCKER-IN-DOCKER (esto no cambia) -----
  dind:
    image: docker:24.0-dind
    privileged: true
    volumes:
      - jenkins-docker-certs:/certs/client
    ports:
      - "2375:2375"
    environment:
      - DOCKER_TLS_CERTDIR=/certs

volumes:
  jenkins-data:
  jenkins-docker-certs:
