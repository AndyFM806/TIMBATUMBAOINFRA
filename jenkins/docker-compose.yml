services:
  # ----- JENKINS CONTROLLER & DIND (Default services) -----
  jenkins-controller:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - ./jcasc:/var/jenkins_home/casc_configs
      - jenkins-data:/var/jenkins_home
    env_file:
      - ./.env
    depends_on:
      dind:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/login"]
      interval: 10s
      timeout: 5s
      retries: 30

  dind:
    image: docker:24.0-dind
    privileged: true
    expose:
      - "2375"
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----- AGENT IMAGE BUILDS (Assigned to the 'agents' profile to prevent auto-starting) -----
  terraform-agent:
    image: custom-agent/terraform
    build:
      context: ./agents/terraform
    profiles: ["agents"]

  node-agent:
    image: custom-agent/node
    build:
      context: ./agents/node
    profiles: ["agents"]

  maven-agent:
    image: custom-agent/maven
    build:
      context: ./agents/maven
    profiles: ["agents"]

  docker-agent:
    image: custom-agent/docker
    build:
      context: ./agents/docker
    profiles: ["agents"]

volumes:
  jenkins-data: