jenkins:
  systemMessage: "Jenkins configurado con acceso directo admin/admin"

  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "admin"
          password: "admin"

  authorizationStrategy:
    loggedInUsersCanDoAnything:
      allowAnonymousRead: false

  disableRememberMe: false

  clouds:
    - docker:
        name: "dind-cloud"
        dockerApi:
          dockerHost:
            uri: "tcp://docker-dind:2375"

        templates:

          - name: "docker-agent"
            labelString: "docker"
            remoteFs: "/home/jenkins"
            instanceCapStr: "5"
            dockerTemplateBase:
              image: "docker:27-dind"   
              tty: true
            retentionStrategy:
              idleMinutes: 10
            connector:
              attach:
                user: "root"             

          - name: "terraform-agent"
            labelString: "terraform"
            remoteFs: "/home/jenkins"
            instanceCapStr: "5"
            dockerTemplateBase:
              image: "hashicorp/terraform:1.14
              tty: true
            retentionStrategy:
              idleMinutes: 10
            connector:
              attach:
                user: "root"

jobs:
  - script: >
      pipelineJob('infra-dind-job') {
        definition {
          cps {
            script("""
              pipeline {
                agent none

                stages {
                  stage('Probar agente Docker') {
                    agent { label 'docker' }
                    steps {
                      sh 'echo Hola desde el agente Docker'
                      sh 'hostname'
                      sh 'docker --version || echo "docker CLI no instalado"'
                    }
                  }

                  stage('Probar agente Terraform') {
                    agent { label 'terraform' }
                    steps {
                      sh 'echo Hola desde el agente Terraform'
                      sh 'hostname'
                      sh 'terraform version || echo "Terraform no instalado"'
                    }
                  }
                }
              }
            """)
            sandbox()
          }
        }
      }
